<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi Página con Needle Widget</title>
  <!-- Agrega el script del widget de Needle en el head -->
  <script src="https://cdn.needle.app/widget/v2/main.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f9f9f9;
    }
    h1 {
      color: #333;
    }
    .contenido {
      margin-bottom: 40px;
    }
  </style>
</head>
<body>
  <div class="contenido">
    <h1>Bienvenido al Chatbot Prototipo (v1) de EXCELIA DESARROLLOS</h1>
    <p>Esta es una página de ejemplo con el widget de Needle integrado.</p>
  </div>

  <!-- Agrega el widget de Needle aquí -->
  <needle-embedded-widget
    client-key="clk_01KAY2A5DNE4WQFZ7JY9ZS9QDD"
    collection-id="clt_01KANVHTST30K60YGWXKXWEW3K"
    title="Chatea con nuestro asistente virtual"
    initial-message="¡Hola! ¿En qué puedo ayudarte?"
    theme="system"
  ></needle-embedded-widget>

<script>
const webhookUrl = 'https://api.needle.app/webhook/wfl_01K8RNGQS4XN272VTMGKM78ZH1'; // Reemplaza por tu URL real

window.addEventListener('DOMContentLoaded', () => {
  const widget = document.querySelector('needle-embedded-widget');
  let historialConversacion = [];

  // Mensaje del usuario
  widget.addEventListener('message-sent', (event) => {
    const mensaje = event.detail?.message?.content || '';
    if (!mensaje) return;

    historialConversacion.push('Usuario: ' + mensaje);

    // Si el usuario escribe "Fin", envía el historial al webhook
    if (mensaje.trim().toLowerCase() === 'fin') {
      fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ historial: historialConversacion.join('\n') })
      })
      .then(res => {
        if (res.ok) {
          alert('Historial enviado correctamente');
          historialConversacion = [];
        } else {
          alert('Error al enviar historial');
        }
      });
    }
  });

  // Mensaje del bot
  widget.addEventListener('message-received', (event) => {
    const mensaje = event.detail?.message?.content || '';
    if (!mensaje) return;
    historialConversacion.push('Bot: ' + mensaje);
  });
});
</script>

</body>

</html>

